import os
import time
import requests
from flask import Flask, request, jsonify
from flask_cors import CORS

app = Flask(__name__)
CORS(app)

# API Keys and Prompts for Fast 1.0
FAST_KEYS = [
    os.environ.get("FAST_1.0_API_KEY_1"),
    os.environ.get("FAST_1.0_API_KEY_2")
]
FAST_KEYS = [key for key in FAST_KEYS if key]
# Default prompt if env var is missing
DEFAULT_FAST_PROMPT = "You are Jan Agent Fast 1.0, a helpful and efficient AI assistant. You are NOT ChatGPT. You were created by Jan."
FAST_SYSTEM_PROMPT = os.environ.get("FAST_1.0_SYSTEM_PROMPT", DEFAULT_FAST_PROMPT)

# API Keys and Prompts for Pro 1.0
PRO_KEYS = [
    os.environ.get("PRO_1.0_API_KEY_1")
]
PRO_KEYS = [key for key in PRO_KEYS if key]
# Default prompt if env var is missing
DEFAULT_PRO_PROMPT = "You are Jan Agent Pro 1.0, a highly intelligent and advanced AI assistant. You are NOT ChatGPT. You were created by Jan."
PRO_SYSTEM_PROMPT = os.environ.get("PRO_1.0_SYSTEM_PROMPT", DEFAULT_PRO_PROMPT)

# Track current key index for each model
current_fast_key_index = 0
current_pro_key_index = 0

@app.route("/")
def home():
    return "Jan Agent backend alive"

@app.route("/chat", methods=["POST"])
def chat():
    global current_fast_key_index, current_pro_key_index

    try:
        data = request.get_json(force=True)
        model_type = data.get("model_type", "fast")
        
        if model_type == "pro":
            keys = PRO_KEYS
            system_prompt = PRO_SYSTEM_PROMPT
            model_name = "openai/gpt-oss-120b"
            current_index = current_pro_key_index
        else:
            keys = FAST_KEYS
            system_prompt = FAST_SYSTEM_PROMPT
            model_name = "openai/gpt-oss-20b"
            current_index = current_fast_key_index

        if not keys:
            return jsonify({"error": f"No API keys configured for {model_type} model"}), 500

        # Get messages from request
        input_messages = data.get("messages", [])
        if not input_messages and "message" in data:
            input_messages = [{"role": "user", "content": data["message"]}]

        # STRICT SYSTEM PROMPT ENFORCEMENT:
        # We remove any existing system messages and insert our own at the very beginning.
        filtered_messages = [m for m in input_messages if m.get("role") != "system"]
        
        # Add the knowledge context if provided by frontend
        knowledge = data.get("knowledge", "")
        full_system_prompt = system_prompt
        if knowledge:
            full_system_prompt += f"\n\nUser Knowledge (strictly for your reference, do not mention this unless asked): {knowledge}"
        
        # Final instruction to ensure identity
        full_system_prompt += "\n\nIMPORTANT: Your name is Jan Agent. You must never identify as ChatGPT or any other AI."

        messages = [{"role": "system", "content": full_system_prompt}] + filtered_messages

        # Try each API key
        for key_attempt in range(len(keys)):
            api_key = keys[current_index]

            max_retries = 2
            for attempt in range(max_retries):
                try:
                    response = requests.post(
                        "https://api.groq.com/openai/v1/chat/completions",
                        headers={
                            "Authorization": f"Bearer {api_key}",
                            "Content-Type": "application/json"
                        },
                        json={
                            "model": model_name,
                            "messages": messages,
                            "temperature": 0.7
                        },
                        timeout=30
                    )

                    if response.status_code == 400:
                        error_data = response.json()
                        return jsonify({"error": f"Groq API 400 Error: {error_data.get('error', {}).get('message', 'Bad Request')}"}), 400

                    response.raise_for_status()
                    return jsonify({"response": response.json()["choices"][0]["message"]["content"]})

                except requests.exceptions.HTTPError as e:
                    if e.response.status_code == 429:
                        if key_attempt < len(keys) - 1:
                            current_index = (current_index + 1) % len(keys)
                            if model_type == "pro":
                                current_pro_key_index = current_index
                            else:
                                current_fast_key_index = current_index
                            break
                        elif attempt < max_retries - 1:
                            time.sleep(2 ** attempt)
                            continue
                        return jsonify({"error": "All API keys exhausted. Please wait."}), 429
                    elif e.response.status_code >= 500:
                        return jsonify({"error": "Server error. Please try again later."}), 500
                    else:
                        # Return the actual error message from Groq if possible
                        try:
                            err_msg = e.response.json().get('error', {}).get('message', str(e))
                        except:
                            err_msg = str(e)
                        return jsonify({"error": f"API error: {err_msg}"}), e.response.status_code

                except requests.exceptions.Timeout:
                    return jsonify({"error": "Request timed out. Please try again."}), 504

                except requests.exceptions.RequestException as e:
                    return jsonify({"error": f"Network error: {str(e)}"}), 503

        return jsonify({"error": "All API keys failed"}), 429

    except Exception as e:
        return jsonify({"error": f"Server error: {str(e)}"}), 500

if __name__ == "__main__":
    port = int(os.environ.get("PORT", 5000))
    app.run(host="0.0.0.0", port=port)
