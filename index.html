import os
from flask import Flask, request, jsonify
from flask_cors import CORS
from groq import Groq

app = Flask(__name__)
CORS(app)

# Initialize Groq client lazily or with a check
def get_groq_client():
    api_key = os.environ.get("GROQ_API_KEY")
    if not api_key:
        # This will help you see the error in Render logs
        raise ValueError("GROQ_API_KEY environment variable is not set")
    return Groq(api_key=api_key)

@app.route("/chat", methods=["POST"])
def chat():
    try:
        # Initialize client inside the route or ensure it's available
        client = get_groq_client()
        
        data = request.json
        user_message = data.get("message")
        
        if not user_message:
            return jsonify({"error": "No message provided"}), 400

        completion = client.chat.completions.create(
            model="llama-3.1-8b-instant",
            messages=[
                {"role": "user", "content": user_message}
            ],
        )
        
        bot_response = completion.choices[0].message.content
        return jsonify({"response": bot_response})

    except ValueError as ve:
        return jsonify({"error": str(ve)}), 500
    except Exception as e:
        return jsonify({"error": f"Unexpected error: {str(e)}"}), 500

@app.route("/health", methods=["GET"])
def health():
    return jsonify({"status": "ok", "api_key_set": "GROQ_API_KEY" in os.environ})

if __name__ == "__main__":
    port = int(os.environ.get("PORT", 5000))
    app.run(host="0.0.0.0", port=port)
